name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8.15.0'

jobs:
  # ============================================
  # Quality Checks Job
  # ============================================
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm prisma:generate

      - name: Check code formatting
        run: pnpm format:check

      - name: Run linting
        run: pnpm lint

      - name: Run type checking
        run: pnpm typecheck

  # ============================================
  # Test Job
  # ============================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm prisma:generate

      - name: Run tests
        run: pnpm test

  # ============================================
  # Build Job
  # ============================================
  build:
    name: Build All Apps
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [quality-checks, test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm prisma:generate

      - name: Build all apps
        run: pnpm build
        env:
          # Provide dummy env vars for build time
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
          JWT_SECRET: "dummy-jwt-secret-for-build"
          JWT_REFRESH_SECRET: "dummy-jwt-refresh-secret-for-build"
          NEXT_PUBLIC_API_URL: "https://api.raverpay.com"

  # ============================================
  # Security Scan Job
  # ============================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit
        run: pnpm audit --audit-level=critical
        continue-on-error: true

      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified --since-commit HEAD~1
        continue-on-error: true

  # ============================================
  # Deploy to Railway (Only on push to main)
  # ============================================
  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build, security-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy raverpay-api to Railway
        run: |
          railway up --service @raverpay/raverpay-api --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Wait for deployment to complete
        run: sleep 120

      - name: Health check
        run: |
          max_attempts=10
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Health check attempt $attempt/$max_attempts"
            
            response=$(curl -s -o /dev/null -w "%{http_code}" https://api.raverpay.com/api/health || echo "000")
            
            if [ "$response" = "200" ]; then
              echo "✅ Health check passed!"
              exit 0
            fi
            
            echo "❌ Health check failed (HTTP $response). Retrying in 10 seconds..."
            sleep 20
            attempt=$((attempt + 1))
          done
          
          echo "❌ Health check failed after $max_attempts attempts"
          exit 1

  # ============================================
  # Notify Job (runs on success or failure)
  # ============================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Send success email
        if: needs.deploy.result == 'success'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp-mail.outlook.com
          server_port: 587
          username: ${{ secrets.NOTIFICATION_EMAIL }}
          password: ${{ secrets.NOTIFICATION_EMAIL_PASSWORD }}
          subject: '✅ RaverPay Deployment Successful - ${{ github.sha }}'
          to: raverpay@outlook.com
          from: ${{ secrets.NOTIFICATION_EMAIL }}
          body: |
            Deployment to Railway completed successfully!
            
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            Message: ${{ github.event.head_commit.message }}
            
            View deployment: https://api.raverpay.com
            View commit: ${{ github.event.head_commit.url }}

      - name: Send failure email
        if: needs.deploy.result == 'failure'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp-mail.outlook.com
          server_port: 587
          username: ${{ secrets.NOTIFICATION_EMAIL }}
          password: ${{ secrets.NOTIFICATION_EMAIL_PASSWORD }}
          subject: '❌ RaverPay Deployment Failed - ${{ github.sha }}'
          to: raverpay@outlook.com
          from: ${{ secrets.NOTIFICATION_EMAIL }}
          body: |
            ⚠️ Deployment to Railway FAILED!
            
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            Message: ${{ github.event.head_commit.message }}
            
            Please check the GitHub Actions logs:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

