// MularPay Fintech Database Schema
// This schema defines all database models for the Nigerian fintech app

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id        String     @id @default(uuid())
  email     String     @unique
  phone     String     @unique
  password  String // Argon2 hashed
  firstName String
  lastName  String
  role      UserRole   @default(USER)
  status    UserStatus @default(PENDING_VERIFICATION)
  kycTier   KYCTier    @default(TIER_0)

  // Profile
  avatar      String?
  dateOfBirth DateTime?
  gender      Gender?
  address     String?
  city        String?
  state       String?
  country     String    @default("Nigeria")

  // KYC Data
  bvn         String? @unique
  bvnVerified Boolean @default(false)
  nin         String? @unique
  ninVerified Boolean @default(false)

  // Paystack Integration
  paystackCustomerCode String? @unique // Paystack customer code for DVA

  // Security
  pin                  String? // Encrypted 4-digit transaction PIN
  pinSetAt             DateTime?
  twoFactorEnabled     Boolean   @default(false)
  twoFactorSecret      String?
  passwordResetAt      DateTime? // Track when password was last reset
  lastPasswordChange   DateTime? // Track when password was last changed
  failedLoginAttempts  Int       @default(0)
  lockedUntil          DateTime? // Account lock expiry time
  lastFailedLoginAt    DateTime? // Last failed login attempt
  lastSuccessfulLoginIp String?  // Last successful login IP address

  // Account Deletion
  deletionRequested   Boolean   @default(false)
  deletionRequestedAt DateTime?
  deletedAt           DateTime? // Soft delete timestamp

  // Profile Edit Tracking
  profileEditedOnce Boolean   @default(false)
  profileEditedAt   DateTime?

  // Push Notifications
  expoPushToken       String?   // Expo push notification token
  lastPushTokenUpdate DateTime? // Last time push token was updated

  // Timestamps
  emailVerified   Boolean   @default(false)
  emailVerifiedAt DateTime?
  phoneVerified   Boolean   @default(false)
  phoneVerifiedAt DateTime?
  lastLoginAt     DateTime?
  lastLoginEmailSentAt DateTime? // Track when last login notification email was sent
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  wallets                Wallet[] // Changed from wallet Wallet?
  transactions           Transaction[]
  vtuOrders              VTUOrder[]
  giftCardOrders         GiftCardOrder[]
  cryptoOrders           CryptoOrder[]
  bankAccounts           BankAccount[]
  virtualAccounts        VirtualAccount[]
  notifications          Notification[]
  notificationPreference NotificationPreference?
  notificationLogs       NotificationLog[]
  notificationQueue      NotificationQueue[]
  auditLogs              AuditLog[]
  refreshTokens          RefreshToken[]
  savedRecipients        SavedRecipient[]
  deletionRequests       AccountDeletionRequest[]

  // Support System Relations
  conversations          Conversation[]
  tickets                Ticket[]
  assignedTickets        Ticket[]        @relation("AssignedTickets")
  cannedResponses        CannedResponse[] @relation("CannedResponseCreator")

  // Cashback Relations
  cashbackWallet         CashbackWallet?
  cashbackTransactions   CashbackTransaction[]

  // Crypto Relations
  venlyUser              VenlyUser?
  cryptoTransactions     CryptoTransaction[]
  cryptoConversions      CryptoConversion[]

  // Device Management
  devices                Device[]

  // Email Relations
  inboundEmails          InboundEmail[] @relation("InboundEmails")

  @@index([email])
  @@index([phone])
  @@index([status])
  @@map("users")
}

enum UserRole {
  USER
  SUPPORT
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
  LOCKED // Account temporarily locked due to failed login attempts
  PENDING_VERIFICATION
  PENDING_DELETION
  DELETED
}

enum KYCTier {
  TIER_0 // Not verified - ₦50k limit
  TIER_1 // Email + Phone - ₦300k limit
  TIER_2 // BVN verified - ₦5M limit
  TIER_3 // Full KYC - Unlimited
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

// ============================================
// REFRESH TOKEN MANAGEMENT
// ============================================

model RefreshToken {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  token     String   @unique
  isRevoked Boolean  @default(false)
  expiresAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// Device Management for single device login
model Device {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Device Identification
  deviceId          String   @unique // Unique device fingerprint
  deviceName        String // e.g., "iPhone 13 Pro"
  deviceType        String // "ios", "android", "web"
  deviceModel       String? // e.g., "iPhone13,3"
  osVersion         String? // e.g., "iOS 16.0"
  appVersion        String? // App version at time of registration

  // Location & Network
  ipAddress         String
  lastIpAddress     String?
  location          String? // e.g., "Lagos, Nigeria"
  userAgent         String?

  // Status
  isActive          Boolean  @default(true) // Only one device can be active
  isVerified        Boolean  @default(false) // Device verified via OTP
  isTrusted         Boolean  @default(false) // Trusted device (no OTP needed)

  // Timestamps
  firstLoginAt      DateTime @default(now())
  lastLoginAt       DateTime @default(now())
  lastActivityAt    DateTime @default(now())
  verifiedAt        DateTime?
  deactivatedAt     DateTime?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@index([deviceId])
  @@index([isActive])
  @@map("devices")
}

// ============================================
// WALLET SYSTEM
// ============================================

enum WalletType {
  NAIRA // Existing
  CRYPTO // New - holds USDT, USDC, MATIC
  USD // Future - for virtual card funding
}

model Wallet {
  id     String     @id @default(uuid())
  userId String
  user   User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Wallet type
  type WalletType

  // For NAIRA wallet (existing)
  balance       Decimal @default(0) @db.Decimal(15, 2)
  ledgerBalance Decimal @default(0) @db.Decimal(15, 2)
  currency      String  @default("NGN") // NGN, USD, or CRYPTO

  // For CRYPTO wallet (new)
  venlyWalletId String? @unique // Venly's wallet ID
  walletAddress String? @unique // Blockchain address (0x...)

  // Limits tracking
  dailySpent   Decimal  @default(0) @db.Decimal(15, 2)
  monthlySpent Decimal  @default(0) @db.Decimal(15, 2)
  lastResetAt  DateTime @default(now())

  // Status
  isLocked     Boolean @default(false)
  lockedReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  cryptoBalances CryptoBalance[]

  @@unique([userId, type]) // User can have one NAIRA, one CRYPTO, one USD wallet
  @@index([userId])
  @@index([type])
  @@index([walletAddress])
  @@index([venlyWalletId])
  @@map("wallets")
}

// ============================================
// TRANSACTIONS (Double-entry bookkeeping)
// ============================================

model Transaction {
  id        String @id @default(uuid())
  reference String @unique // e.g., TXN_1234567890

  userId String
  user   User   @relation(fields: [userId], references: [id])

  type   TransactionType
  status TransactionStatus @default(PENDING)

  amount           Decimal @db.Decimal(15, 2)
  fee              Decimal @default(0) @db.Decimal(15, 2)
  cashbackRedeemed Decimal @default(0) @db.Decimal(15, 2) // Cashback discount applied
  totalAmount      Decimal @db.Decimal(15, 2) // amount + fee - cashbackRedeemed

  balanceBefore Decimal @db.Decimal(15, 2)
  balanceAfter  Decimal @db.Decimal(15, 2)

  currency String @default("NGN")

  // Additional data (JSON for flexibility)
  metadata Json?

  // Related entities
  relatedType String? // e.g., "vtu_order", "giftcard_order"
  relatedId   String?

  // Provider info (for external transactions)
  provider       String? // e.g., "paystack", "vtpass"
  providerRef    String?
  providerStatus String?
  channel        String? // e.g., "BANK_TRANSFER", "CARD", "USSD"

  // Descriptions
  description String
  narration   String?

  // Timestamps
  completedAt DateTime?
  failedAt    DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([reference])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt]) // Composite index for admin queries filtering by status
  @@index([type, createdAt]) // Composite index for admin queries filtering by type
  @@index([userId, createdAt]) // Composite index for user transaction history
  @@map("transactions")
}

// Daily Transaction Limits Tracking
model DailyTransactionLimit {
  id     String @id @default(uuid())
  userId String
  date   DateTime @default(now()) // Date for this limit tracking (YYYY-MM-DD)

  // Spending tracking
  totalTransferred  Decimal @default(0) @db.Decimal(15, 2) // Total transfers + withdrawals
  totalWithdrawn    Decimal @default(0) @db.Decimal(15, 2) // Withdrawals only
  totalAirtime      Decimal @default(0) @db.Decimal(15, 2) // Airtime purchases
  totalData         Decimal @default(0) @db.Decimal(15, 2) // Data purchases
  totalBillPayments Decimal @default(0) @db.Decimal(15, 2) // Cable TV + Electricity

  // Transaction counts
  transferCount     Int @default(0)
  withdrawalCount   Int @default(0)
  airtimeCount      Int @default(0)
  dataCount         Int @default(0)
  billPaymentCount  Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
  @@map("daily_transaction_limits")
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  TRANSFER
  VTU_AIRTIME
  VTU_DATA
  VTU_CABLE
  VTU_ELECTRICITY
  GIFTCARD_BUY
  GIFTCARD_SELL
  CRYPTO_BUY
  CRYPTO_SELL
  REFUND
  FEE

  // New crypto wallet types
  CRYPTO_DEPOSIT // Incoming crypto
  CRYPTO_SEND // Outgoing crypto
  CRYPTO_TO_NAIRA // Crypto → Naira conversion

  // Future: USD wallet types
  USD_DEPOSIT // Add to USD wallet
  USD_WITHDRAWAL // Withdraw from USD wallet
  CARD_LOAD // Load virtual card
  CARD_PURCHASE // Virtual card purchase
  CRYPTO_TO_USD // Crypto → USD wallet
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REVERSED
}

// ============================================
// BANK ACCOUNTS & VIRTUAL ACCOUNTS
// ============================================

model BankAccount {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  bankName      String
  bankCode      String
  accountNumber String
  accountName   String

  isVerified Boolean @default(false)
  isPrimary  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, accountNumber])
  @@index([userId])
  @@map("bank_accounts")
}

model VirtualAccount {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  provider      String // e.g., "paystack"
  bankName      String
  bankCode      String
  accountNumber String @unique
  accountName   String

  providerRef String?
  isActive    Boolean @default(true)

  // DVA Creation Status Tracking
  creationStatus String? // PENDING | PROCESSING | ACTIVE | FAILED
  retryCount     Int     @default(0)
  lastRetryAt    DateTime?
  failureReason  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([accountNumber])
  @@index([creationStatus])
  @@map("virtual_accounts")
}

// ============================================
// VTU (VIRTUAL TOP-UP) SERVICES
// ============================================

model VTUOrder {
  id        String @id @default(uuid())
  reference String @unique

  userId String
  user   User   @relation(fields: [userId], references: [id])

  serviceType VTUServiceType
  provider    String // MTN, GLO, AIRTEL, 9MOBILE, DSTV, etc.

  // Recipient details
  recipient String // Phone number or smartcard number

  // Product details
  productCode String
  productName String
  amount      Decimal @db.Decimal(15, 2)

  // Status
  status TransactionStatus @default(PENDING)

  // Provider response
  providerRef      String?
  providerToken    String?
  providerResponse Json?

  // Transaction reference
  transactionId String?

  // Cashback fields
  cashbackEarned     Decimal @default(0) @db.Decimal(15, 2) // Cashback earned from this purchase
  cashbackRedeemed   Decimal @default(0) @db.Decimal(15, 2) // Cashback applied to this purchase
  cashbackPercentage Decimal @default(0) @db.Decimal(5, 2) // Percentage used for calculation

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@index([userId])
  @@index([reference])
  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt]) // Composite index for admin queries
  @@index([userId, createdAt]) // Composite index for user order history
  @@map("vtu_orders")
}

enum VTUServiceType {
  AIRTIME
  DATA
  CABLE_TV
  ELECTRICITY
}

// ============================================
// GIFT CARDS
// ============================================

model GiftCardOrder {
  id        String @id @default(uuid())
  reference String @unique

  userId String
  user   User   @relation(fields: [userId], references: [id])

  type    GiftCardType // BUY or SELL
  brand   String // AMAZON, APPLE, STEAM, etc.
  country String // US, UK, CA, etc.

  // Card details (for selling)
  cardNumber String? // Encrypted
  cardPin    String? // Encrypted
  cardImages Json? // Array of image URLs

  // Pricing
  faceValue Decimal @db.Decimal(15, 2)
  rate      Decimal @db.Decimal(5, 2) // Exchange rate
  amount    Decimal @db.Decimal(15, 2) // Amount in Naira

  status TransactionStatus @default(PENDING)

  // Admin review
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?

  // Transaction reference
  transactionId String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@index([userId])
  @@index([reference])
  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt]) // Composite index for admin queries
  @@index([userId, createdAt]) // Composite index for user order history
  @@map("giftcard_orders")
}

enum GiftCardType {
  BUY
  SELL
}

// ============================================
// CRYPTO TRADING
// ============================================

model CryptoOrder {
  id        String @id @default(uuid())
  reference String @unique

  userId String
  user   User   @relation(fields: [userId], references: [id])

  type    CryptoOrderType // BUY or SELL
  asset   String // BTC, ETH, USDT
  network String // BTC, ETH, TRC20, BEP20

  // Amounts
  cryptoAmount Decimal @db.Decimal(18, 8)
  nairaAmount  Decimal @db.Decimal(15, 2)
  rate         Decimal @db.Decimal(15, 2) // Exchange rate per unit

  // Wallet address (for selling)
  walletAddress String?

  // Transaction hash (for verification)
  txHash String?

  status TransactionStatus @default(PENDING)

  // Provider info
  provider    String? // e.g., "binance", "crypto.com"
  providerRef String?

  // Transaction reference
  transactionId String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@index([userId])
  @@index([reference])
  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt]) // Composite index for admin queries
  @@index([userId, createdAt]) // Composite index for user order history
  @@map("crypto_orders")
}

enum CryptoOrderType {
  BUY
  SELL
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification classification
  type      NotificationType
  eventType String? // "deposit", "withdrawal", "bvn_verified", etc.
  category  NotificationCategory @default(SYSTEM)

  // Content
  title   String
  message String
  data    Json?

  // Multi-channel support
  channels String[] @default(["in-app"]) // ["email", "sms", "in-app", "push"]

  // Delivery tracking
  deliveryStatus Json? // { "email": "sent", "sms": "failed", "push": "pending" }

  // Template reference
  templateId String?
  variables  Json? // Variables used to render template

  // Read status
  isRead Boolean   @default(false)
  readAt DateTime?

  // Lifecycle
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expiresAt DateTime? // Auto-cleanup old notifications

  // Relations
  logs NotificationLog[]

  @@index([userId])
  @@index([isRead])
  @@index([eventType])
  @@index([category])
  @@index([createdAt])
  @@index([userId, isRead, createdAt]) // Composite for user unread notifications
  @@index([userId, createdAt]) // Composite for user notification history
  @@map("notifications")
}

enum NotificationType {
  TRANSACTION
  KYC
  SECURITY
  PROMOTIONAL
  SYSTEM
}

enum NotificationCategory {
  TRANSACTION
  SECURITY
  KYC
  PROMOTIONAL
  SYSTEM
  ACCOUNT
}

// ============================================
// NOTIFICATION PREFERENCES
// ============================================

model NotificationPreference {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Channel preferences
  emailEnabled Boolean @default(true)
  smsEnabled   Boolean @default(false) // SMS costs money - opt-in only
  pushEnabled  Boolean @default(true)
  inAppEnabled Boolean @default(true)

  // Event type preferences
  transactionEmails Boolean @default(true)
  transactionSms    Boolean @default(false) // SMS costs money - opt-in only
  transactionPush   Boolean @default(true)

  securityEmails Boolean @default(true)
  securitySms    Boolean @default(false) // SMS costs money - opt-in only
  securityPush   Boolean @default(true)

  kycEmails Boolean @default(true)
  kycSms    Boolean @default(false) // SMS costs money - opt-in only
  kycPush   Boolean @default(true)

  promotionalEmails Boolean @default(true) // Opt-out model for marketing
  promotionalSms    Boolean @default(false) // SMS costs money - opt-in only
  promotionalPush   Boolean @default(true) // Opt-out model for marketing

  // Frequency controls
  emailFrequency NotificationFrequency @default(IMMEDIATE)
  smsFrequency   NotificationFrequency @default(IMMEDIATE)
  pushFrequency  NotificationFrequency @default(IMMEDIATE)

  // Do not disturb
  quietHoursEnabled Boolean @default(false)
  quietHoursStart   String? // "22:00"
  quietHoursEnd     String? // "06:00"
  timeZone          String  @default("Africa/Lagos")

  // Opt-outs
  optOutCategories String[] @default([]) // Categories user opted out of

  // OneSignal Push Notification Tokens
  oneSignalPlayerId   String? // OneSignal subscription/player ID
  oneSignalExternalId String? // External user ID (should match userId)
  lastPushTokenUpdate DateTime? // Last time push token was updated

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("notification_preferences")
}

enum NotificationFrequency {
  IMMEDIATE
  DAILY
  WEEKLY
  NEVER
}

// ============================================
// NOTIFICATION LOGS (Delivery Tracking)
// ============================================

model NotificationLog {
  id             String       @id @default(uuid())
  notificationId String
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Channel info
  channel NotificationChannel
  status  NotificationStatus  @default(PENDING)

  // Delivery tracking
  sentAt        DateTime?
  deliveredAt   DateTime?
  failureReason String?
  retryCount    Int       @default(0)
  lastRetryAt   DateTime?

  // Analytics
  openedAt  DateTime?
  clickedAt DateTime?
  clickUrl  String?

  // Provider info
  provider          String? // "resend", "termii", "vtpass", "onesignal"
  providerMessageId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([channel])
  @@index([status])
  @@index([notificationId])
  @@map("notification_logs")
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
  IN_APP
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
  OPENED
  CLICKED
}

// ============================================
// NOTIFICATION TEMPLATES
// ============================================

model NotificationTemplate {
  id String @id @default(uuid())

  // Template identification
  name      String              @unique
  eventType String // "deposit", "withdrawal", "bvn_verified", etc.
  channel   NotificationChannel

  // Content
  subject      String? // For email/push
  bodyTemplate String // Can use {{variable}} syntax

  // Metadata
  isActive  Boolean  @default(true)
  version   Int      @default(1)
  variables String[] // ["firstName", "amount", "reference"]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventType, channel, version])
  @@index([eventType])
  @@index([isActive])
  @@map("notification_templates")
}

// ============================================
// NOTIFICATION QUEUE (Async Processing)
// ============================================

model NotificationQueue {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification details
  channel   NotificationChannel
  eventType String

  // Template data
  templateId String?
  variables  Json? // { "firstName": "John", "amount": "1000" }

  // Status
  status   QueueStatus @default(QUEUED)
  priority Int         @default(0)

  // Retry logic
  retryCount  Int       @default(0)
  maxRetries  Int       @default(3)
  nextRetryAt DateTime?
  lastError   String?

  // Execution
  scheduledFor DateTime?
  sentAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([channel])
  @@index([scheduledFor])
  @@index([priority])
  // Composite index for the queue processing query (fixes slow query)
  @@index([channel, status, scheduledFor, nextRetryAt, priority, createdAt])
  @@map("notification_queue")
}

enum QueueStatus {
  QUEUED
  PROCESSING
  SENT
  FAILED
  CANCELLED
}

// ============================================
// AUDIT LOGS
// ============================================

model AuditLog {
  id     String  @id @default(uuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  action     String
  resource   String
  resourceId String?

  ipAddress String?
  userAgent String?

  metadata Json?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([action, createdAt]) // Composite index for admin queries by action
  @@index([resource, resourceId]) // Composite index for resource lookups
  @@index([userId, createdAt]) // Composite index for user activity history
  @@map("audit_logs")
}

// ============================================
// SAVED RECIPIENTS (FOR VTU SERVICES)
// ============================================

model SavedRecipient {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Service details
  serviceType VTUServiceType // AIRTIME, DATA, CABLE_TV, ELECTRICITY
  provider    String // MTN, GLO, DSTV, IKEDC, etc.

  // Recipient details
  recipient     String // Phone number, smartcard, meter number
  recipientName String? // Optional friendly name (e.g., "Mom", "Office")

  // Usage tracking
  lastUsedAt DateTime @default(now())
  usageCount Int      @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, serviceType, recipient]) // Prevent duplicates
  @@index([userId])
  @@index([userId, serviceType])
  @@index([lastUsedAt])
  @@map("saved_recipients")
}

// ============================================
// ACCOUNT DELETION REQUESTS
// ============================================

model AccountDeletionRequest {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Request details
  reason       String
  customReason String? // If user selects "Other"

  // Verification
  passwordVerified Boolean @default(true)

  // Status tracking
  status DeletionRequestStatus @default(PENDING)

  // Admin review
  reviewedBy      String? // Admin user ID
  reviewedAt      DateTime?
  reviewNotes     String?
  rejectionReason String?

  // Timestamps
  requestedAt  DateTime  @default(now())
  scheduledFor DateTime? // When deletion should occur
  deletedAt    DateTime? // When actually deleted

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([requestedAt])
  @@map("account_deletion_requests")
}

enum DeletionRequestStatus {
  PENDING // Waiting for admin review
  APPROVED // Admin approved, scheduled for deletion
  REJECTED // Admin rejected the request
  COMPLETED // Account deleted
  CANCELLED // User cancelled the request
}

// ============================================
// SYSTEM CONFIGURATION
// ============================================

model SystemConfig {
  id    String @id @default(uuid())
  key   String @unique
  value Json

  updatedBy String?
  updatedAt DateTime @updatedAt

  @@map("system_config")
}

// ============================================
// APP RATING CONFIGURATION
// ============================================

model AppRatingConfig {
  id                     String  @id @default(uuid())
  enabled                Boolean @default(true)
  promptFrequencyDays    Int     @default(30) // Days between prompts
  minTransactionsRequired Int    @default(3) // Minimum successful transactions
  minUsageDaysRequired   Int     @default(7) // Minimum days since registration
  promptTitle            String  @default("Enjoying RaverPay?")
  promptMessage          String  @default("Rate us on the app store! Your feedback helps us improve.")
  iosAppStoreUrl         String
  androidPlayStoreUrl    String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("app_rating_config")
}

// ============================================
// SUPPORT SYSTEM
// ============================================

model Conversation {
  id                 String             @id @default(uuid())
  userId             String
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  status             ConversationStatus @default(OPEN)
  category           String?
  lastMessagePreview String?
  unreadCount        Int                @default(0)

  // Transaction context (when conversation starts from transaction screen)
  transactionId      String?
  transactionType    String?
  transactionContext Json? // Full transaction context for quick reference

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  messages     Message[]
  ticket       Ticket?
  inboundEmail InboundEmail? @relation("EmailConversations")

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([userId, status])
  @@map("conversations")
}

enum ConversationStatus {
  OPEN
  BOT_HANDLING
  AWAITING_AGENT
  AGENT_ASSIGNED
  AWAITING_RATING
  ENDED
}

model Message {
  id             String     @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderType     SenderType
  senderId       String? // User ID or Agent ID

  content     String  @db.Text
  attachments Json? // Array of file URLs
  isRead      Boolean @default(false)
  metadata    Json? // For quick reply buttons, transaction cards, etc.

  createdAt DateTime @default(now())

  @@index([conversationId])
  @@index([createdAt])
  @@index([conversationId, createdAt])
  @@map("messages")
}

enum SenderType {
  USER
  BOT
  AGENT
  SYSTEM
}

model Ticket {
  id             String   @id @default(uuid())
  ticketNumber   Int      @unique @default(autoincrement())
  conversationId String   @unique
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  category String
  title    String
  status   TicketStatus   @default(OPEN)
  priority TicketPriority @default(MEDIUM)

  // Assignment
  assignedAgentId String?
  assignedAgent   User?  @relation("AssignedTickets", fields: [assignedAgentId], references: [id], onDelete: SetNull)

  // Rating after resolution
  rating        Int? // 1-5 for emoji ratings
  ratingComment String?

  // Email integration
  inboundEmail    InboundEmail? @relation("EmailTickets")

  // Timestamps
  resolvedAt DateTime?
  closedAt   DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([assignedAgentId])
  @@index([ticketNumber])
  @@index([createdAt])
  @@index([status, priority])
  @@index([status, createdAt])
  @@map("tickets")
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ============================================
// INBOUND EMAIL SYSTEM
// ============================================

model InboundEmail {
  id              String   @id @default(uuid())
  emailId         String   @unique // Resend email ID
  messageId       String?  // Email message ID

  // Email metadata
  from            String   // Sender email
  fromName        String?  // Sender name
  to              String   // Recipient (support@, admin@, etc.)
  cc              String[] @default([])
  bcc             String[] @default([])
  subject         String
  textBody        String?  @db.Text
  htmlBody        String?  @db.Text

  // Routing
  targetRole      UserRole? // Which role/team this email is for
  targetEmail     String   // Which email address received it

  // Integration with support system
  ticketId        String?  @unique
  ticket          Ticket?  @relation("EmailTickets", fields: [ticketId], references: [id], onDelete: SetNull)
  conversationId  String?  @unique
  conversation    Conversation? @relation("EmailConversations", fields: [conversationId], references: [id], onDelete: SetNull)

  // User matching (if sender is a registered user)
  userId          String?
  user            User?    @relation("InboundEmails", fields: [userId], references: [id], onDelete: SetNull)

  // Attachments
  attachments     Json?    // Array of attachment metadata

  // Status
  isProcessed     Boolean  @default(false)
  processedAt     DateTime?
  processingError String?  @db.Text

  // Timestamps
  receivedAt      DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([targetRole])
  @@index([targetEmail])
  @@index([userId])
  @@index([ticketId])
  @@index([conversationId])
  @@index([isProcessed])
  @@index([receivedAt])
  @@map("inbound_emails")
}

model EmailRouting {
  id                String   @id @default(uuid())
  emailAddress      String   @unique // e.g., "support@raverpay.com"
  targetRole        UserRole // Which role can access this
  autoCreateTicket  Boolean  @default(false) // Auto-create ticket?
  defaultPriority   TicketPriority? // Default priority for tickets
  defaultCategory   String? // Default category
  isActive          Boolean  @default(true)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([targetRole])
  @@index([isActive])
  @@map("email_routing")
}

// ============================================
// HELP CENTER
// ============================================

model HelpCollection {
  id          String @id @default(uuid())
  title       String
  description String
  icon        String? // Icon name or URL
  order       Int    @default(0)
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  articles HelpArticle[]

  @@index([order])
  @@index([isActive])
  @@map("help_collections")
}

model HelpArticle {
  id           String         @id @default(uuid())
  collectionId String
  collection   HelpCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  title   String
  content String @db.Text // Rich text/markdown content
  slug    String @unique // For URL-friendly access
  order   Int    @default(0)

  // Analytics
  viewCount      Int @default(0)
  helpfulCount   Int @default(0)
  unhelpfulCount Int @default(0)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([collectionId])
  @@index([order])
  @@index([isActive])
  @@index([slug])
  @@map("help_articles")
}

// ============================================
// CANNED RESPONSES (FOR AGENTS)
// ============================================

model CannedResponse {
  id          String  @id @default(uuid())
  title       String
  content     String  @db.Text
  category    String?
  shortcut    String? // Quick access shortcut e.g., "/greeting"
  isActive    Boolean @default(true)
  usageCount  Int     @default(0)
  createdById String
  createdBy   User    @relation("CannedResponseCreator", fields: [createdById], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([isActive])
  @@index([shortcut])
  @@map("canned_responses")
}

// ============================================
// CASHBACK SYSTEM
// ============================================

model CashbackConfig {
  id String @id @default(uuid())

  // Service configuration
  serviceType VTUServiceType

  // Cashback settings
  percentage Decimal @db.Decimal(5, 2) // E.g., 2.00 for 2%
  isActive   Boolean @default(true)

  // Optional: Provider-specific rates
  provider String? // MTN, GLO, AIRTEL, 9MOBILE, DSTV, GOTV, etc.

  // Minimum transaction amount to earn cashback
  minAmount Decimal @default(0) @db.Decimal(15, 2)

  // Maximum cashback per transaction
  maxCashback Decimal? @db.Decimal(15, 2)

  // Metadata
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([serviceType, provider])
  @@index([serviceType])
  @@index([isActive])
  @@map("cashback_config")
}

model CashbackWallet {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Balances
  totalEarned      Decimal @default(0) @db.Decimal(15, 2) // Lifetime earnings
  availableBalance Decimal @default(0) @db.Decimal(15, 2) // Current spendable
  totalRedeemed    Decimal @default(0) @db.Decimal(15, 2) // Lifetime redemptions

  // Status
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("cashback_wallets")
}

model CashbackTransaction {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Transaction details
  type   CashbackTransactionType
  amount Decimal @db.Decimal(15, 2)

  // Balance tracking
  balanceBefore Decimal @db.Decimal(15, 2)
  balanceAfter  Decimal @db.Decimal(15, 2)

  // Source transaction reference
  sourceReference String? // Reference to original VTU transaction

  // Metadata
  description String
  metadata    Json?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([sourceReference])
  @@index([type])
  @@index([createdAt])
  @@index([userId, createdAt]) // Composite index for user history
  @@map("cashback_transactions")
}

enum CashbackTransactionType {
  EARNED
  REDEEMED
  EXPIRED
  REVERSED
}

// ============================================
// WITHDRAWAL CONFIGURATION
// ============================================

model WithdrawalConfig {
  id String @id @default(uuid())

  // Fee configuration
  feeType  WithdrawalFeeType @default(PERCENTAGE)
  feeValue Decimal           @db.Decimal(15, 2) // e.g., 50 for ₦50 flat, or 1.5 for 1.5%
  minFee   Decimal           @default(0) @db.Decimal(15, 2)
  maxFee   Decimal?          @db.Decimal(15, 2)

  // Limits per KYC tier (optional - if null, uses default from code)
  tierLevel KYCTier? // Which tier this config applies to

  // Global limits (used if tierLevel is null)
  minWithdrawal Decimal @default(100) @db.Decimal(15, 2)
  maxWithdrawal Decimal @default(50000) @db.Decimal(15, 2)

  // Status
  isActive Boolean @default(true)

  // Metadata
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tierLevel]) // Only one config per tier
  @@index([isActive])
  @@map("withdrawal_config")
}

enum WithdrawalFeeType {
  FLAT       // Fixed amount (e.g., ₦50 per withdrawal)
  PERCENTAGE // Percentage of amount (e.g., 1.5%)
}

// ============================================
// CRYPTO WALLET SYSTEM
// ============================================

// ============================================
// CRYPTO BALANCES (Per Token)
// ============================================

model CryptoBalance {
  id       String @id @default(uuid())
  walletId String
  wallet   Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  // Token info
  tokenSymbol   String  // USDT, USDC, MATIC
  tokenAddress  String? // Contract address (null for native MATIC)
  tokenDecimals Int     @default(18) // 6 for USDT/USDC, 18 for MATIC

  // Balance
  balance    Decimal @db.Decimal(36, 18) // Human-readable
  rawBalance String // Blockchain raw value (wei/smallest unit)

  // USD values (live updated)
  usdPrice Decimal? @db.Decimal(18, 8) // Current price in USD
  usdValue Decimal? @db.Decimal(18, 2) // Total value (balance * price)

  lastUpdated DateTime @default(now())

  @@unique([walletId, tokenSymbol])
  @@index([walletId])
  @@index([tokenSymbol])
  @@map("crypto_balances")
}

// ============================================
// CRYPTO TRANSACTIONS
// ============================================

model CryptoTransaction {
  id              String @id @default(uuid())
  reference       String @unique // TXN_CRYPTO_xxx
  transactionHash String @unique // Blockchain tx hash

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  walletId String

  // Transaction type & direction
  type      CryptoTransactionType
  direction TransactionDirection

  // Addresses
  fromAddress String
  toAddress   String

  // Token details
  tokenSymbol   String
  tokenAddress  String?
  tokenDecimals Int     @default(6)

  // Amounts
  amount    Decimal @db.Decimal(36, 18) // Human-readable
  rawAmount String // Blockchain raw value
  usdValue  Decimal @db.Decimal(18, 2) // USD value at time of tx

  // Gas (only for outgoing)
  gasFee    Decimal? @db.Decimal(10, 6) // In MATIC
  gasFeeUsd Decimal? @db.Decimal(10, 2) // Gas in USD

  // Blockchain details
  network            String  @default("MATIC") // MATIC, ETH, etc.
  blockNumber        Int?
  blockHash          String?
  confirmations      Int     @default(0)
  hasReachedFinality Boolean @default(false)
  nonce              Int?

  // Status
  status        CryptoTransactionStatus @default(PENDING)
  failureReason String?

  // Metadata
  memo String? // User note/description

  // Timestamps
  submittedAt DateTime  @default(now())
  confirmedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([walletId])
  @@index([transactionHash])
  @@index([status])
  @@index([type])
  @@index([direction])
  @@index([submittedAt])
  @@index([status, submittedAt])
  @@map("crypto_transactions")
}

enum CryptoTransactionType {
  RECEIVE // Incoming crypto
  SEND // Outgoing crypto
  CONVERT // Convert to Naira (internal)
}

enum TransactionDirection {
  INCOMING
  OUTGOING
}

enum CryptoTransactionStatus {
  PENDING // Submitted to blockchain
  CONFIRMING // Accumulating confirmations
  COMPLETED // Finalized
  FAILED // Failed on blockchain
}

// ============================================
// CRYPTO → NAIRA CONVERSIONS
// ============================================

model CryptoConversion {
  id        String @id @default(uuid())
  reference String @unique // TXN_CRYPTO_CONVERT_xxx

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Crypto details
  tokenSymbol  String
  cryptoAmount Decimal @db.Decimal(36, 18)
  usdValue     Decimal @db.Decimal(18, 2) // Crypto → USD

  // Naira details
  nairaAmount    Decimal @db.Decimal(18, 2) // Final amount
  exchangeRate   Decimal @db.Decimal(10, 2) // USD → NGN rate
  feePercent     Decimal @db.Decimal(5, 2) // Platform fee %
  feeAmount      Decimal @db.Decimal(18, 2) // Fee in Naira
  netNaira       Decimal @db.Decimal(18, 2) // After fee

  // Status
  status ConversionStatus @default(PENDING)

  // Admin approval (if needed)
  requiresApproval Boolean   @default(false)
  approvedBy       String? // Admin user ID
  approvedAt       DateTime?
  rejectionReason  String?

  // Transaction references
  cryptoTransactionId String? // Debit from crypto wallet
  nairaTransactionId  String? // Credit to naira wallet

  // Timestamps
  requestedAt DateTime  @default(now())
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([status])
  @@index([requestedAt])
  @@map("crypto_conversions")
}

enum ConversionStatus {
  PENDING // Awaiting processing
  PROCESSING // Being processed
  COMPLETED // Naira credited
  FAILED // Failed
  REJECTED // Admin rejected
}

// ============================================
// EXCHANGE RATES (Admin Managed)
// ============================================

model ExchangeRate {
  id String @id @default(uuid())

  // Rate configuration
  fromCurrency String // USD
  toCurrency   String // NGN
  rate         Decimal @db.Decimal(10, 2) // Exchange rate (e.g., 1650.00)

  // Fee
  platformFeePercent Decimal @db.Decimal(5, 2) // Platform fee % (e.g., 1.00)

  // Status
  isActive Boolean @default(true)

  // Admin tracking
  setBy     String // Admin user ID
  setAt     DateTime  @default(now())
  expiresAt DateTime? // Optional expiry

  // Metadata
  source String? // "manual", "binance_api", "coingecko"
  notes  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fromCurrency, toCurrency, isActive])
  @@index([isActive])
  @@map("exchange_rates")
}

// ============================================
// CRYPTO PRICES (Live from API)
// ============================================

model CryptoPrice {
  id String @id @default(uuid())

  symbol   String // MATIC, USDT, USDC
  usdPrice Decimal @db.Decimal(18, 8) // Current price in USD

  // Source
  source String @default("coingecko") // coingecko, binance, etc.

  // Timestamps
  fetchedAt DateTime @default(now())
  createdAt DateTime @default(now())

  @@unique([symbol, fetchedAt])
  @@index([symbol])
  @@index([fetchedAt])
  @@map("crypto_prices")
}

// ============================================
// WEBHOOK LOGS
// ============================================

model CryptoWebhookLog {
  id String @id @default(uuid())

  // Webhook details
  eventType String // TRANSACTION_SUCCEEDED, TRANSACTION_FAILED
  payload   Json // Full webhook payload

  // Processing
  processed   Boolean   @default(false)
  processedAt DateTime?
  error       String?

  // Extracted data (for quick lookup)
  transactionHash String?
  fromAddress     String?
  toAddress       String?
  amount          Decimal? @db.Decimal(18, 8)
  tokenSymbol     String?

  receivedAt DateTime @default(now())

  @@index([eventType])
  @@index([transactionHash])
  @@index([processed])
  @@index([receivedAt])
  @@map("crypto_webhook_logs")
}

// ============================================
// VENLY USER MANAGEMENT
// ============================================

model VenlyUser {
  id String @id @default(uuid())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Venly credentials
  venlyUserId          String @unique // Venly's user ID
  venlySigningMethodId String? // PIN signing method ID
  venlyReference       String // Custom reference

  // PIN security (encrypted)
  encryptedPin String // Never store plain PIN!
  pinSetAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([venlyUserId])
  @@index([userId])
  @@map("venly_users")
}
