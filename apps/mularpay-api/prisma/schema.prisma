// MularPay Fintech Database Schema
// This schema defines all database models for the Nigerian fintech app

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id        String     @id @default(uuid())
  email     String     @unique
  phone     String     @unique
  password  String // Argon2 hashed
  firstName String
  lastName  String
  role      UserRole   @default(USER)
  status    UserStatus @default(PENDING_VERIFICATION)
  kycTier   KYCTier    @default(TIER_0)

  // Profile
  avatar      String?
  dateOfBirth DateTime?
  gender      Gender?
  address     String?
  city        String?
  state       String?
  country     String    @default("Nigeria")

  // KYC Data
  bvn         String? @unique
  bvnVerified Boolean @default(false)
  nin         String? @unique
  ninVerified Boolean @default(false)

  // Paystack Integration
  paystackCustomerCode String? @unique // Paystack customer code for DVA

  // Security
  pin                String? // Encrypted 4-digit transaction PIN
  pinSetAt           DateTime?
  twoFactorEnabled   Boolean   @default(false)
  twoFactorSecret    String?
  passwordResetAt    DateTime? // Track when password was last reset
  lastPasswordChange DateTime? // Track when password was last changed

  // Account Deletion
  deletionRequested   Boolean   @default(false)
  deletionRequestedAt DateTime?

  // Profile Edit Tracking
  profileEditedOnce Boolean   @default(false)
  profileEditedAt   DateTime?

  // Push Notifications
  expoPushToken       String?   // Expo push notification token
  lastPushTokenUpdate DateTime? // Last time push token was updated

  // Timestamps
  emailVerified   Boolean   @default(false)
  emailVerifiedAt DateTime?
  phoneVerified   Boolean   @default(false)
  phoneVerifiedAt DateTime?
  lastLoginAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  wallet                 Wallet?
  transactions           Transaction[]
  vtuOrders              VTUOrder[]
  giftCardOrders         GiftCardOrder[]
  cryptoOrders           CryptoOrder[]
  bankAccounts           BankAccount[]
  virtualAccounts        VirtualAccount[]
  notifications          Notification[]
  notificationPreference NotificationPreference?
  notificationLogs       NotificationLog[]
  notificationQueue      NotificationQueue[]
  auditLogs              AuditLog[]
  refreshTokens          RefreshToken[]
  savedRecipients        SavedRecipient[]
  deletionRequests       AccountDeletionRequest[]

  // Support System Relations
  conversations          Conversation[]
  tickets                Ticket[]
  assignedTickets        Ticket[]        @relation("AssignedTickets")
  cannedResponses        CannedResponse[] @relation("CannedResponseCreator")

  @@index([email])
  @@index([phone])
  @@index([status])
  @@map("users")
}

enum UserRole {
  USER
  SUPPORT
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
  PENDING_VERIFICATION
  PENDING_DELETION
}

enum KYCTier {
  TIER_0 // Not verified - ₦50k limit
  TIER_1 // Email + Phone - ₦300k limit
  TIER_2 // BVN verified - ₦5M limit
  TIER_3 // Full KYC - Unlimited
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

// ============================================
// REFRESH TOKEN MANAGEMENT
// ============================================

model RefreshToken {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  token     String   @unique
  isRevoked Boolean  @default(false)
  expiresAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ============================================
// WALLET SYSTEM
// ============================================

model Wallet {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  balance       Decimal @default(0) @db.Decimal(15, 2)
  ledgerBalance Decimal @default(0) @db.Decimal(15, 2) // Balance including pending transactions
  currency      String  @default("NGN")

  // Limits tracking (reset daily/monthly)
  dailySpent   Decimal  @default(0) @db.Decimal(15, 2)
  monthlySpent Decimal  @default(0) @db.Decimal(15, 2)
  lastResetAt  DateTime @default(now())

  isLocked     Boolean @default(false)
  lockedReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("wallets")
}

// ============================================
// TRANSACTIONS (Double-entry bookkeeping)
// ============================================

model Transaction {
  id        String @id @default(uuid())
  reference String @unique // e.g., TXN_1234567890

  userId String
  user   User   @relation(fields: [userId], references: [id])

  type   TransactionType
  status TransactionStatus @default(PENDING)

  amount      Decimal @db.Decimal(15, 2)
  fee         Decimal @default(0) @db.Decimal(15, 2)
  totalAmount Decimal @db.Decimal(15, 2) // amount + fee

  balanceBefore Decimal @db.Decimal(15, 2)
  balanceAfter  Decimal @db.Decimal(15, 2)

  currency String @default("NGN")

  // Additional data (JSON for flexibility)
  metadata Json?

  // Related entities
  relatedType String? // e.g., "vtu_order", "giftcard_order"
  relatedId   String?

  // Provider info (for external transactions)
  provider       String? // e.g., "paystack", "vtpass"
  providerRef    String?
  providerStatus String?
  channel        String? // e.g., "BANK_TRANSFER", "CARD", "USSD"

  // Descriptions
  description String
  narration   String?

  // Timestamps
  completedAt DateTime?
  failedAt    DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([reference])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt]) // Composite index for admin queries filtering by status
  @@index([type, createdAt]) // Composite index for admin queries filtering by type
  @@index([userId, createdAt]) // Composite index for user transaction history
  @@map("transactions")
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  TRANSFER
  VTU_AIRTIME
  VTU_DATA
  VTU_CABLE
  VTU_ELECTRICITY
  GIFTCARD_BUY
  GIFTCARD_SELL
  CRYPTO_BUY
  CRYPTO_SELL
  REFUND
  FEE
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REVERSED
}

// ============================================
// BANK ACCOUNTS & VIRTUAL ACCOUNTS
// ============================================

model BankAccount {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  bankName      String
  bankCode      String
  accountNumber String
  accountName   String

  isVerified Boolean @default(false)
  isPrimary  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, accountNumber])
  @@index([userId])
  @@map("bank_accounts")
}

model VirtualAccount {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  provider      String // e.g., "paystack"
  bankName      String
  bankCode      String
  accountNumber String @unique
  accountName   String

  providerRef String?
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([accountNumber])
  @@map("virtual_accounts")
}

// ============================================
// VTU (VIRTUAL TOP-UP) SERVICES
// ============================================

model VTUOrder {
  id        String @id @default(uuid())
  reference String @unique

  userId String
  user   User   @relation(fields: [userId], references: [id])

  serviceType VTUServiceType
  provider    String // MTN, GLO, AIRTEL, 9MOBILE, DSTV, etc.

  // Recipient details
  recipient String // Phone number or smartcard number

  // Product details
  productCode String
  productName String
  amount      Decimal @db.Decimal(15, 2)

  // Status
  status TransactionStatus @default(PENDING)

  // Provider response
  providerRef      String?
  providerToken    String?
  providerResponse Json?

  // Transaction reference
  transactionId String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@index([userId])
  @@index([reference])
  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt]) // Composite index for admin queries
  @@index([userId, createdAt]) // Composite index for user order history
  @@map("vtu_orders")
}

enum VTUServiceType {
  AIRTIME
  DATA
  CABLE_TV
  ELECTRICITY
}

// ============================================
// GIFT CARDS
// ============================================

model GiftCardOrder {
  id        String @id @default(uuid())
  reference String @unique

  userId String
  user   User   @relation(fields: [userId], references: [id])

  type    GiftCardType // BUY or SELL
  brand   String // AMAZON, APPLE, STEAM, etc.
  country String // US, UK, CA, etc.

  // Card details (for selling)
  cardNumber String? // Encrypted
  cardPin    String? // Encrypted
  cardImages Json? // Array of image URLs

  // Pricing
  faceValue Decimal @db.Decimal(15, 2)
  rate      Decimal @db.Decimal(5, 2) // Exchange rate
  amount    Decimal @db.Decimal(15, 2) // Amount in Naira

  status TransactionStatus @default(PENDING)

  // Admin review
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?

  // Transaction reference
  transactionId String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@index([userId])
  @@index([reference])
  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt]) // Composite index for admin queries
  @@index([userId, createdAt]) // Composite index for user order history
  @@map("giftcard_orders")
}

enum GiftCardType {
  BUY
  SELL
}

// ============================================
// CRYPTO TRADING
// ============================================

model CryptoOrder {
  id        String @id @default(uuid())
  reference String @unique

  userId String
  user   User   @relation(fields: [userId], references: [id])

  type    CryptoOrderType // BUY or SELL
  asset   String // BTC, ETH, USDT
  network String // BTC, ETH, TRC20, BEP20

  // Amounts
  cryptoAmount Decimal @db.Decimal(18, 8)
  nairaAmount  Decimal @db.Decimal(15, 2)
  rate         Decimal @db.Decimal(15, 2) // Exchange rate per unit

  // Wallet address (for selling)
  walletAddress String?

  // Transaction hash (for verification)
  txHash String?

  status TransactionStatus @default(PENDING)

  // Provider info
  provider    String? // e.g., "binance", "crypto.com"
  providerRef String?

  // Transaction reference
  transactionId String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@index([userId])
  @@index([reference])
  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt]) // Composite index for admin queries
  @@index([userId, createdAt]) // Composite index for user order history
  @@map("crypto_orders")
}

enum CryptoOrderType {
  BUY
  SELL
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification classification
  type      NotificationType
  eventType String? // "deposit", "withdrawal", "bvn_verified", etc.
  category  NotificationCategory @default(SYSTEM)

  // Content
  title   String
  message String
  data    Json?

  // Multi-channel support
  channels String[] @default(["in-app"]) // ["email", "sms", "in-app", "push"]

  // Delivery tracking
  deliveryStatus Json? // { "email": "sent", "sms": "failed", "push": "pending" }

  // Template reference
  templateId String?
  variables  Json? // Variables used to render template

  // Read status
  isRead Boolean   @default(false)
  readAt DateTime?

  // Lifecycle
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expiresAt DateTime? // Auto-cleanup old notifications

  // Relations
  logs NotificationLog[]

  @@index([userId])
  @@index([isRead])
  @@index([eventType])
  @@index([category])
  @@index([createdAt])
  @@index([userId, isRead, createdAt]) // Composite for user unread notifications
  @@index([userId, createdAt]) // Composite for user notification history
  @@map("notifications")
}

enum NotificationType {
  TRANSACTION
  KYC
  SECURITY
  PROMOTIONAL
  SYSTEM
}

enum NotificationCategory {
  TRANSACTION
  SECURITY
  KYC
  PROMOTIONAL
  SYSTEM
  ACCOUNT
}

// ============================================
// NOTIFICATION PREFERENCES
// ============================================

model NotificationPreference {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Channel preferences
  emailEnabled Boolean @default(true)
  smsEnabled   Boolean @default(false) // SMS costs money - opt-in only
  pushEnabled  Boolean @default(true)
  inAppEnabled Boolean @default(true)

  // Event type preferences
  transactionEmails Boolean @default(true)
  transactionSms    Boolean @default(false) // SMS costs money - opt-in only
  transactionPush   Boolean @default(true)

  securityEmails Boolean @default(true)
  securitySms    Boolean @default(false) // SMS costs money - opt-in only
  securityPush   Boolean @default(true)

  kycEmails Boolean @default(true)
  kycSms    Boolean @default(false) // SMS costs money - opt-in only
  kycPush   Boolean @default(true)

  promotionalEmails Boolean @default(true) // Opt-out model for marketing
  promotionalSms    Boolean @default(false) // SMS costs money - opt-in only
  promotionalPush   Boolean @default(true) // Opt-out model for marketing

  // Frequency controls
  emailFrequency NotificationFrequency @default(IMMEDIATE)
  smsFrequency   NotificationFrequency @default(IMMEDIATE)
  pushFrequency  NotificationFrequency @default(IMMEDIATE)

  // Do not disturb
  quietHoursEnabled Boolean @default(false)
  quietHoursStart   String? // "22:00"
  quietHoursEnd     String? // "06:00"
  timeZone          String  @default("Africa/Lagos")

  // Opt-outs
  optOutCategories String[] @default([]) // Categories user opted out of

  // OneSignal Push Notification Tokens
  oneSignalPlayerId   String? // OneSignal subscription/player ID
  oneSignalExternalId String? // External user ID (should match userId)
  lastPushTokenUpdate DateTime? // Last time push token was updated

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("notification_preferences")
}

enum NotificationFrequency {
  IMMEDIATE
  DAILY
  WEEKLY
  NEVER
}

// ============================================
// NOTIFICATION LOGS (Delivery Tracking)
// ============================================

model NotificationLog {
  id             String       @id @default(uuid())
  notificationId String
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Channel info
  channel NotificationChannel
  status  NotificationStatus  @default(PENDING)

  // Delivery tracking
  sentAt        DateTime?
  deliveredAt   DateTime?
  failureReason String?
  retryCount    Int       @default(0)
  lastRetryAt   DateTime?

  // Analytics
  openedAt  DateTime?
  clickedAt DateTime?
  clickUrl  String?

  // Provider info
  provider          String? // "resend", "termii", "vtpass", "onesignal"
  providerMessageId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([channel])
  @@index([status])
  @@index([notificationId])
  @@map("notification_logs")
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
  IN_APP
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
  OPENED
  CLICKED
}

// ============================================
// NOTIFICATION TEMPLATES
// ============================================

model NotificationTemplate {
  id String @id @default(uuid())

  // Template identification
  name      String              @unique
  eventType String // "deposit", "withdrawal", "bvn_verified", etc.
  channel   NotificationChannel

  // Content
  subject      String? // For email/push
  bodyTemplate String // Can use {{variable}} syntax

  // Metadata
  isActive  Boolean  @default(true)
  version   Int      @default(1)
  variables String[] // ["firstName", "amount", "reference"]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventType, channel, version])
  @@index([eventType])
  @@index([isActive])
  @@map("notification_templates")
}

// ============================================
// NOTIFICATION QUEUE (Async Processing)
// ============================================

model NotificationQueue {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification details
  channel   NotificationChannel
  eventType String

  // Template data
  templateId String?
  variables  Json? // { "firstName": "John", "amount": "1000" }

  // Status
  status   QueueStatus @default(QUEUED)
  priority Int         @default(0)

  // Retry logic
  retryCount  Int       @default(0)
  maxRetries  Int       @default(3)
  nextRetryAt DateTime?
  lastError   String?

  // Execution
  scheduledFor DateTime?
  sentAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([channel])
  @@index([scheduledFor])
  @@index([priority])
  // Composite index for the queue processing query (fixes slow query)
  @@index([channel, status, scheduledFor, nextRetryAt, priority, createdAt])
  @@map("notification_queue")
}

enum QueueStatus {
  QUEUED
  PROCESSING
  SENT
  FAILED
  CANCELLED
}

// ============================================
// AUDIT LOGS
// ============================================

model AuditLog {
  id     String  @id @default(uuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  action     String
  resource   String
  resourceId String?

  ipAddress String?
  userAgent String?

  metadata Json?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([action, createdAt]) // Composite index for admin queries by action
  @@index([resource, resourceId]) // Composite index for resource lookups
  @@index([userId, createdAt]) // Composite index for user activity history
  @@map("audit_logs")
}

// ============================================
// SAVED RECIPIENTS (FOR VTU SERVICES)
// ============================================

model SavedRecipient {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Service details
  serviceType VTUServiceType // AIRTIME, DATA, CABLE_TV, ELECTRICITY
  provider    String // MTN, GLO, DSTV, IKEDC, etc.

  // Recipient details
  recipient     String // Phone number, smartcard, meter number
  recipientName String? // Optional friendly name (e.g., "Mom", "Office")

  // Usage tracking
  lastUsedAt DateTime @default(now())
  usageCount Int      @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, serviceType, recipient]) // Prevent duplicates
  @@index([userId])
  @@index([userId, serviceType])
  @@index([lastUsedAt])
  @@map("saved_recipients")
}

// ============================================
// ACCOUNT DELETION REQUESTS
// ============================================

model AccountDeletionRequest {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Request details
  reason       String
  customReason String? // If user selects "Other"

  // Verification
  passwordVerified Boolean @default(true)

  // Status tracking
  status DeletionRequestStatus @default(PENDING)

  // Admin review
  reviewedBy      String? // Admin user ID
  reviewedAt      DateTime?
  reviewNotes     String?
  rejectionReason String?

  // Timestamps
  requestedAt  DateTime  @default(now())
  scheduledFor DateTime? // When deletion should occur
  deletedAt    DateTime? // When actually deleted

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([requestedAt])
  @@map("account_deletion_requests")
}

enum DeletionRequestStatus {
  PENDING // Waiting for admin review
  APPROVED // Admin approved, scheduled for deletion
  REJECTED // Admin rejected the request
  COMPLETED // Account deleted
  CANCELLED // User cancelled the request
}

// ============================================
// SYSTEM CONFIGURATION
// ============================================

model SystemConfig {
  id    String @id @default(uuid())
  key   String @unique
  value Json

  updatedBy String?
  updatedAt DateTime @updatedAt

  @@map("system_config")
}

// ============================================
// SUPPORT SYSTEM
// ============================================

model Conversation {
  id                 String             @id @default(uuid())
  userId             String
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  status             ConversationStatus @default(OPEN)
  category           String?
  lastMessagePreview String?
  unreadCount        Int                @default(0)

  // Transaction context (when conversation starts from transaction screen)
  transactionId      String?
  transactionType    String?
  transactionContext Json? // Full transaction context for quick reference

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  messages Message[]
  ticket   Ticket?

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([userId, status])
  @@map("conversations")
}

enum ConversationStatus {
  OPEN
  BOT_HANDLING
  AWAITING_AGENT
  AGENT_ASSIGNED
  AWAITING_RATING
  ENDED
}

model Message {
  id             String     @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderType     SenderType
  senderId       String? // User ID or Agent ID

  content     String  @db.Text
  attachments Json? // Array of file URLs
  isRead      Boolean @default(false)
  metadata    Json? // For quick reply buttons, transaction cards, etc.

  createdAt DateTime @default(now())

  @@index([conversationId])
  @@index([createdAt])
  @@index([conversationId, createdAt])
  @@map("messages")
}

enum SenderType {
  USER
  BOT
  AGENT
  SYSTEM
}

model Ticket {
  id             String   @id @default(uuid())
  ticketNumber   Int      @unique @default(autoincrement())
  conversationId String   @unique
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  category String
  title    String
  status   TicketStatus   @default(OPEN)
  priority TicketPriority @default(MEDIUM)

  // Assignment
  assignedAgentId String?
  assignedAgent   User?  @relation("AssignedTickets", fields: [assignedAgentId], references: [id], onDelete: SetNull)

  // Rating after resolution
  rating        Int? // 1-5 for emoji ratings
  ratingComment String?

  // Timestamps
  resolvedAt DateTime?
  closedAt   DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([assignedAgentId])
  @@index([ticketNumber])
  @@index([createdAt])
  @@index([status, priority])
  @@index([status, createdAt])
  @@map("tickets")
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ============================================
// HELP CENTER
// ============================================

model HelpCollection {
  id          String @id @default(uuid())
  title       String
  description String
  icon        String? // Icon name or URL
  order       Int    @default(0)
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  articles HelpArticle[]

  @@index([order])
  @@index([isActive])
  @@map("help_collections")
}

model HelpArticle {
  id           String         @id @default(uuid())
  collectionId String
  collection   HelpCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  title   String
  content String @db.Text // Rich text/markdown content
  slug    String @unique // For URL-friendly access
  order   Int    @default(0)

  // Analytics
  viewCount      Int @default(0)
  helpfulCount   Int @default(0)
  unhelpfulCount Int @default(0)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([collectionId])
  @@index([order])
  @@index([isActive])
  @@index([slug])
  @@map("help_articles")
}

// ============================================
// CANNED RESPONSES (FOR AGENTS)
// ============================================

model CannedResponse {
  id          String  @id @default(uuid())
  title       String
  content     String  @db.Text
  category    String?
  shortcut    String? // Quick access shortcut e.g., "/greeting"
  isActive    Boolean @default(true)
  usageCount  Int     @default(0)
  createdById String
  createdBy   User    @relation("CannedResponseCreator", fields: [createdById], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([isActive])
  @@index([shortcut])
  @@map("canned_responses")
}
